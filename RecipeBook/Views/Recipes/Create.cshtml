@using RecipeBook.ViewModels.Recipes;
@model RecipeEditViewModel
@{
    ViewData["Title"] = "Създай рецепта";
}

<h2>Създай рецепта</h2>


<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Description"></label>
                <textarea asp-for="Description" class="form-control" rows="6"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Instructions"></label>
                <textarea asp-for="Instructions" class="form-control" rows="6"></textarea>
                <span asp-validation-for="Instructions" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Servings" class="control-label"></label>
                <input asp-for="Servings" class="form-control" />
                <span asp-validation-for="Servings" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="CookingTime" class="control-label"></label>
                <input asp-for="CookingTime" class="form-control" />
                <span asp-validation-for="CookingTime" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="CategoryId" class="control-label"></label>
                <select asp-for="CategoryId" class="form-control" asp-items="@Model.Categories"></select>
            </div>
            <div class="form-group">
                <label asp-for="imageFile">Upload Image</label>
                <input type="file" asp-for="imageFile" class="form-control" accept="image/*" />
            </div>
            <div class="form-check">
                <input asp-for="IsVegetarian" class="form-check-input" />
                <label asp-for="IsVegetarian" class="form-check-label"></label>
            </div>
            <div class="form-check">
                <input asp-for="IsVegan" class="form-check-input" />
                <label asp-for="IsVegan" class="form-check-label"></label>
            </div>
            <div class="form-check">
                <input asp-for="IsGlutenFree" class="form-check-input" />
                <label asp-for="IsGlutenFree" class="form-check-label"></label>
            </div>
            <div class="form-check">
                <input asp-for="IsLactoseFree" class="form-check-input" />
                <label asp-for="IsLactoseFree" class="form-check-label"></label>
            </div>

    <hr />
    <h4>Съставки</h4>
    <div class="form-group">
        <input type="text" id="ingredient-search" class="form-control" placeholder="Търси съставка...">
        <ul id="ingredient-results" class="list-group"></ul>
    </div>

    <button type="button" id="add-ingredient-btn" class="btn btn-secondary mt-2">Добави нова съставка</button>

    <table class="table mt-3">
        <thead>
            <tr>
                <th>Съставка</th>
                <th>Количество</th>
                <th>Премахни</th>
            </tr>
        </thead>
        <tbody id="selected-ingredients-table">
        </tbody>
    </table>

    <input type="hidden" name="SelectedIngredientsJson" id="SelectedIngredientsJson" />

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success"> Добави </button>
        <a asp-action="Index" class="btn btn-outline-secondary">Назад</a>
    </div>
</form>



@section Styles {
    <style>
        .border-green {
            border: 2px solid green;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.28.0/dist/ui/trumbowyg.min.css" />
}

@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.28.0/dist/trumbowyg.min.js"></script>

    <script>
        $(document).ready(function () {
                $('textarea[name="Description"]').trumbowyg({
                    btns: [
                        ['strong', 'em', 'underline'],
                        ['unorderedList', 'orderedList'],
                        ['removeformat']
                    ]
                });
        });
    </script>
        
    <script>
        $(document).ready(function () {
                $('textarea[name="Instructions"]').trumbowyg({
                    btns: [
                        ['strong', 'em', 'underline'],
                        ['unorderedList', 'orderedList'],
                        ['removeformat']
                    ]
                });
        });
    </script>

    <script>
        let ingredientsList = [];
        let selectedIngredients = [];

        $(document).ready(function () {
            // Зареждане на съществуващи съставки от сървъра
            $.get("/Ingredients/GetAll", function (data) {
                ingredientsList = data;
            });

            // Филтриране на предложенията при въвеждане
            $('#ingredient-search').on('input', function () {
                const query = $(this).val().toLowerCase();
                if (query === '') {
                    $('#ingredient-results').html('');
                    return;
                }

                const filtered = ingredientsList.filter(i => i.name.toLowerCase().includes(query));
                let html = '';
                filtered.forEach(i => {
                    html += `<li class="list-group-item" data-id="${i.id}" data-name="${i.name}">${i.name}</li>`;
                });
                $('#ingredient-results').html(html);
            });

            // При избор на съществуваща съставка
            $('#ingredient-results').on('click', 'li', function () {
                const id = parseInt($(this).data('id'));
                const name = $(this).data('name');

                if (selectedIngredients.some(i => i.ingredientId === id)) return;

                selectedIngredients.push({
                    ingredientId: id,
                    name: name,
                    quantityNeeded: '',
                    isNew: false
                });
                renderSelectedIngredients();

                $('#ingredient-search').val('');
                $('#ingredient-results').html('');
            });

            // Добавяне на нова съставка от потребител
            $('#add-ingredient-btn').click(function () {
                const name = prompt("Въведи нова съставка:");
                if (!name) return;

                selectedIngredients.push({
                    ingredientId: 0, // <-- 0 за нови съставки
                    name: name,
                    quantityNeeded: '',
                    isNew: true
                });
                renderSelectedIngredients();
            });

            // Промяна на количество
            window.updateQuantity = function (index, value) {
                selectedIngredients[index].quantityNeeded = value;
                syncIngredients();
            };

            // Премахване на съставка
            window.removeIngredient = function (index) {
                selectedIngredients.splice(index, 1);
                renderSelectedIngredients();
            };

            function renderSelectedIngredients() {
                let html = '';
                selectedIngredients.forEach((i, index) => {
                    html += `
                            <tr>
                                <td>${i.name}</td>
                                <td>
                                    <input type="text" class="form-control" value="${i.quantityNeeded}"
                                           onchange="updateQuantity(${index}, this.value)" placeholder="Количество" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger" onclick="removeIngredient(${index})">X</button>
                                </td>
                            </tr>`;
                });
                $('#selected-ingredients-table').html(html);
                syncIngredients();
            }

            function syncIngredients() {
                $('#SelectedIngredientsJson').val(JSON.stringify(selectedIngredients));
            }
        });
    </script>
}